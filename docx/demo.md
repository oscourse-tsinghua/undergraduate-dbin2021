# 基于树状区块链的地图信息存储和展现

## 引言

## 课题背景

## 相关调研

### 区块链与智能合约
区块链是一种新型的那联网应用模式,它具备分布式、去中心化、集体维护、共识机制的特点，目前广泛应用于不同领域中。区块链，具体来说，是一个共享的不可更改的总账，它用于记录交易、跟踪资产以及建立信任。这些资产可以是有形的(房屋，汽车，现金，土地等)或者无形的(知识产权，专利，版权，品牌等)。几乎所有有价值的东西都可以在区块链网络上进行跟踪和交易，从而降低了风险并削减了所有相关人员的成本。交易业务依靠信息，收到的越快、越准确，就会越好。区块链是传递该信息的理想选择，因为它可以提供在不可更改的总账中的即时、共享且完全透明的信息，这类信息智能由获得许可的网络成员访问。另外，区块链网络也可以跟踪订单、付款、账户、生产等等。而且因为成员之间可以共享信息，所以成员可以查看到交易端到端的所有细节，从而带来更好的效率。
区块链有三个关键要素，分布式分类账技术、不可篡改以及智能合约。分布式分类账技术是指所有网络参与者都可以访问分布式分类账以及不可变的交易记录，且所有交易仅记录一次，从而消除传统业务网络中大量的重复工作和数据。不可篡改是指，区块链将交易记录到共享的分类账上后，任何网络参与者都无法更改或篡改该交易，如果交易中包含错误，则必须添加新交易来撤销该错误。
智能合约是存储在区块链上的程序，可以在满足预定条件的情况下运行，它们通常是自动执行的脚本，以便所有参与者无需任何中介机构的参与就可以立即结果，极大保证安全性。智能合约代码语句十分简单，当预定条件已经得到满足并完成验证时，区块链网络将执行对应动作，比如释放资金，发出凭证等，然后交易完成时更新区块链。由智能合约完成的交易也是无法更改的，只有获得许可的参与者才能看到结果。目前很多平台都实现了智能合约功能，使用的较多的还是以太坊上的智能合约。本文的课题也是基于以太坊来进行相关研究。
### 地理数据表示
随着移动用户的剧增，交互式信息地图服务需求正在逐渐增多，矢量数据地图正在兴起。在矢量地图数据中，矢量数据可以在所有放缩水平下以不同的颜色正确显示和区分特征，也正因如此使其正在快速发展。目前矢量地图主要利用`Web Map Tile Service(WMTS)`框架，它可以解决矢量数据分布不均和传输延迟长的问题，在此框架中，地图矢量数据需要被划分为图块，然后根据客户端的请求返回对应图块数据给客户端，通过它们各自的坐标在客户端重新组合，所以矢量数据的编码方式是影响其传输性能和可用性的关键因素。
XML和JSON是web应用程序中常用的两种矢量数据编码方法。`XML`(可扩展标记语言)是一种标记语言，用作Internet信息交换的标准。它具有良好的语义和可扩展性，并且可以灵活地表示数据，但由于XML使用重量级语法，因此会导致其格式复杂且大小较大，不利于上述地图数据传输。`JSON`是一种易于读写的轻量级数据表示格式，`GeoJson`是其中一种轻量级的数据表示方法，用于编码各类地理数据结构，可用于简单表示地理信息。
传统的矢量地图如`Google Maps`,采用二维数据经纬度来表示地理信息，这是一种球面坐标系统，当计算两点间距离时，要利用球面距离计算公式，涉及到复杂的三角函数，不便于计算。`Geohash`是一种新型的地址编码方式，它使用Base32编码成一维的字符串代替二维的经纬度数据。与`Google Maps`编码经纬度编码相比，`GeoHash`将二维空间查询转换为一维字符串匹配，利用此优势，`GeoHash`编码可以实现时间复杂度为`O(1)`快速查询。与Bing Maps相比，GeoHash编码使用Base32编码方法，同一前缀有32个不同子序列，而使用Base64的Bing Maps同一前缀下只有4个子序列。另外，基于GeoHash编码的空间索引算法具有对大量地理数据的高性能查询功能。当前，如Google Maps等主流地图产品采用经纬度表示地理数据坐标位置，而索引则采用另一种方法，GeoHash编码可以将二者结合起来，根据编码长度的不同，GeoHash可以同时表示图块的索引范围和坐标，从而可以实现统一编码。GeoHash编码同时给地理位置进行了分区，在位数较少时，它可以用来表示某一区域在地球上的坐标，在位数足够时，它也可以用来表示某个具体点在地球上的坐标。GeoHash在编码过程中保留了一定的相对地理位置信息，在大部分情况下，GeoHash编码共同前缀越长的区块物理距离越近。
### 车辆位置验证及信誉评估

### 车载自组网的区块链结构
传统区块链技术基于区块，整个网络同时只有一条单片，基于PoW共识机制出块无法并发执行，无法满足车载自组网对高并发操作和网络稳定性的需求，传统区块链也不具备移动性，无法与地理位置信息进行绑定，不能有效利用车载网中地理信息的区域化特性。另外，传统区块链的单链结构，要求所有节点必须在同一区块链中，这将会导致节点数目和数据量过大，不满足车载自组网中车辆节点的移动特性，且一旦出现网络分区，就会对整个区块链产生很大影响。目前采用分片技术更改原始单链的链式结构是解决上述问题的主流方法`[Global 2020]`
#### 多链结构
根据多链结构是否改变底层区块链结构可分为应用多链和结构多链。应用多链，即在应用层面建立不同功能的多个区块链，没有修改底层区块链结构。结构多链，即根据需求对区块链底层结构进行调整的多链结构。
##### 应用多链
`Zhang`等[Intelligent2017]提出了区块链群概念，即将区块链按照电力系统功能分为数据区块链、资产区块链、分析区块链、运营区块链以及支付区块链这5条独立运行的区块链。其中数据区块链为其他各个区块链提供文件服务结构，从分布式文件系统中读取所需数据，其他区块链的计算结果也可通过该接口写入数据区块链。
`[Regional2019]`研究了区域区块链在车载自组网中的应用，它是一个由物理边界区域内的节点共享的区块链。如果将区域区块链用于地理有限的区域，由于较小的传播延迟，可以极大减少到端到的消息延迟，提高区块链中节点交易效率，从理论上说，可以将整个区块链分为多个区域区块链，但该文仅从一个区域区块链内部进行了相关研究，并没有设计跨区域和跨链交易的相关内容。
[e-Health2019]提出了一种给予隐私保护的医疗保健系统，包含专用链和公用链两种区块链模型。专用链，即侧链，用于保存有关患者的真实身份信息；公用链，即主链，用于存储有关患者健康的信息以及标有临时ID的数据，从而实现了隐私数据保护和可用数据公开访问。通过特定节点掌握患者临时ID和真实身份的关联，来实现两个区块链数据的传递。
`[Ocha2020]`提出了一种使用侧链使智能电网具有可扩展性和适应性的区块链架构，将开放式智能电网协议`(OSGP)`集成三个区块链中，分别为`BlockPRI`、`BlockSEC`和`BlockTST`。其中，`BlockPRI`是用于存储每个用户的隐私，`BlockSEC`存储用户的数据，`BlockTST`管理和验证有关消费者-消费者和消费者-公司之间的能源贸易的信息。每个区块链对应一个功能，从整体上保证智能电网网络的隐私性和安全性。
##### 结构多链
结构多链是根据需求对区块链底层结构进行调整的多链结构，根据其组成特点，结构多链又可以分为并发多链和层次多链。并发多链结构扁平，各个子链可以根据需求负责相同或者不同的功能，相互之间地位平等。而层次多链属于多层级结构，至少具备上下层级关系的子链结构，各个层级负责的功能不同，地位也不同。
- 并发多链

  `[Monoxide]`提出异步共识区域，该区域在不影响分散性或安全性的前提下线性扩展了区块链系统。通过建立多个独立并行的单链共识区域来构成并发多链的区块链结构。各个共识组地位平等，大部分交易只在组内完成。分组按指定规则命名，跨组交易采用异步方式将中继事务发送到目标区域，而不是整个网络，减轻了网络负载。此外，为了确保每个区域中的有效采矿能力与整个网络处于同一水平，采用了`Chu-ko-nu`的改进`PoW`挖矿方式，这也同时保证了分组抵御攻击的能力。但其共识组分区方法没有考虑实际地理位置信息，不适用于车载自组网。

  `[RapidChain]`提出了基于分片的公共区块链协议，它将节点划分为多个较小的称为委员会的节点组，节点组在不相交的交易块上并行操作，并维护不相交的独立账本，也就是分片，分片由每个成员以区块链的形式存储。为了解决节点频繁移入移出对网络造成的映像，将委员会将分为活跃和不活跃两个分类，节点创建后，第一次进入委员会需要加入活跃类，再次进入或转移时需要加入不活跃类。`RapidChain`对分片和跨片交易处理，委员会重组，节点移动都有较好的处理，但也存在一些不足。委员会内节点数量固定，缺少灵活性；委员会构建和重构时没有考虑地理因素，增加了更新时间。
  
  `[Pruneable2018]`改进的`Rollerchain`中利用分片技术和`PBFT`（拜占庭式容错）算法提出了一种基于可分片的区块链协议`(PSRB)`。`PSRB`协议采用分片技术，使得`PoW`协商机制能够通过特定的社区分配规则和网络的分片功能实现事务的并发管理。社区分配规则为每个节点计算`PoW`难题，然后根据其`nonce`分配给某个社区。与现有的区块链协议不同，`PSRB`协议在每个节点和主链只存储区块头链和部分区块时，保证了系统的安全性，避免了协议的体积膨胀和容量膨胀问题。由于`nonce`计算的随机性，会出现社区内节点数目差别过大的问题，该方法没有说明对节点处理的方法。
  
- 层次多链

  `[Byung2018]`将物联网与基于区块链的智能合约相结合，用于结构健康监视`(SHM)`，定义新颖，高效，可扩展和安全的分布式网络，增强运营安全性。该在这个区块链物联网网络中，通过将本地集中和全球分散的分布分为核心和边缘网络，激活了本地集中和全球分散分布的特征，并提供了本地数据库的原始数据存储和核心区块链网络的结构事件存储两种类型的存储。边缘节点充当查询实时响应的集中式服务器，并提供低延迟和带宽使用率，核心网络由具有高存储容量的`miner`节点组成，负责生成新块、验证工作证明`（PoW）`，并包含用于自主决策的智能合约，这种划分提高了系统的效率和可伸缩性且可以有效地模拟结构的自主监测和控制，但核心网络十分庞大是主要问题 。

  `[LightChain2019]`为解决部署区块链和处理事务负担过大，提出了`LightChain`的轻量级区块链系统，该系统由`API`层，`LightChain`层， 缓存层和存储层等4层框架构成。`API`层用来读写本地数据和构造区块链交易；`LightChain`层通过数字签名验证和附件验证用来验证交易的有效性和完整性；缓存层是为了加速对调用的响应而设计的，它包含本地操作、未验证的块和有用的块；存储层通常由资源丰富的设备提供服务，为上层提供持久存储服务。其中，`LightChain`层采用模块化设计，又分为`Webchain`、`Conchain`和`Chainbase`三个协作模块。`Webchain`是`LightChain`层的前端，它将`API`层发送的操作类型和`JSON`流转换为预定义的消息类型和内部处理的二进制流；`Conchain`充当共识和`P2P`网络模块。除了执行基于`SMP`的一致性计算之外，它还负责管理对等列表并与它们建立`TCP/IP`连接；`Chainbase`是`LightChain`层的后端，拥有添加、过滤或卸载缓存层缓存的本地分类帐数据的权限。该方法只是将区块链的计算和存储功能分开，未对节点、交易等进行分片或分类。

  `[Multi2021]`提出了一种多层区块链安全模型来保护物联网网络，同时简化了实施过程。为了便于多层体系结构的实现，采用了聚类的概念。在物联网网络中，采用模拟退火和遗传算法相结合的混合进化算法来定义K-未知簇。所选的集群头负责本地身份验证和授权。本地私有区块链的实施促进了集群头和相关基站之间的通信。这样的区块链增强了可信性保证和安全性，同时还提供了网络认证机制。

  `[Blockchain2018Chao]`提出了一个具有分层、交叉和自组织区块链结构`（BCS）`的框架，以建立物联网和区块链之间的关系来验证设备可信度。工作内容包括三个部分：首先，该框架由多个不同层次的区块链组成，上层的区块链节点管理一个下层的区块链，不同的区块链网络可以构成一个层次关系。其次，底层的寄存器数据依次传输到上层区块链节点，并记录在路径中的每个区块链中。最后，可信度验证过程是沿着源设备到目标设备的验证链。该方法中没有对管理节点的选择方法和数量进行研究；同时其可信度验证需要沿层级结构传递，如何合理的设定层级结构的高度或者优化传递路径是有待解决的问题。

  `[Sharma2018]`利用软件定义网络和区块链技术的优势，提出了一种新的智能城市混合网络体系结构。该模型利用区块链技术将智能城市网络分为核心网络和边缘网络。核心网络由具有高计算和存储资源的`miner`节点组成，而边缘节点的存储和计算能力有限。边缘节点根据需要将预处理后的加密数据传输到智慧城市核心网，`Miner`节点将负责创建块和验证工作证明。每个节点都采用`SDN`控制器，实现了高度的灵活性和安全性，降低了硬件管理成本，实现了智能城市网络基础设施的易部署性。通过混合体系结构的设计，文章提出的体系结构继承了集中式和分布式网络体系结构的优点。该结构仅对节点进行分类，并未对区块链的交易和状态进行划分。

  `[Mbs2019]`提出了一个多级区块链框架，以增强物联网应用中的隐私和数据安全。多层次模型侧重于提高响应时间和资源利用率。方案中定义了移动代理来执行哈希函数、实现加密、部署聚合和解密。移动代理在区块链和物联网之间传输，以完成所需的任务。该多层次框架由微观层次（物联网设备层次）、中观层次区块链（物联网的簇头层次）和宏观层次区块链（平台层次或物联网的最高层次）等三层次组成。

  `[Hierarchical2020]`提出了一个可扩展的物联网双层分层区块链体系结构。第一层是基于实用拜占庭容错`（PBFT）`共识来处理高吞吐量的核心引擎，第二层分别由支付引擎、计算引擎和存储引擎组成，用来管理底层的从属引擎（子引擎）。支付引擎负责所有物联网小额支付；计算引擎控制智能合约计算并执行物联网处理逻辑；存储引擎管理物联网数据存储；核心引擎为所有其他引擎的父引擎，起到控制和协调作用。作者将这些子引擎的多个实例部署到尽可能多的位置，并尽量靠近物联网设备所在的物联网域，以应对大量节点。此外，为了进一步扩展所提出的体系结构的可伸缩性，作者还在核心引擎上提供了额外的可伸缩性特性，如请求聚合、请求优先级以及子引擎并行性。该结构按照功能划分子区块链，很好的起到并发执行的效果。但是划分时未考虑物联网设备的地理位置因素，可能会引起远程调用的问题。
## 基于`GeoHash`地图显示

本章主要对`GeoHash`进行介绍，第一小节介绍`GeoHash`编码原理，第二小节介绍`GeoHashTile`原理。

### 简介

`Geohash `是由 `Gustavo Niemeyer` 和 `G.M. Morton` 发明的一种地理编码系统,它将地理位置编码为一个固定长度的字符串,被广泛应用于基于地理位置的应用中。`GeoHash`编码将经度和纬度分别转换为一组二进制字符串，然后交叉地组合在一起形成新的字符串序列，其中，偶数位序列是经度序列，奇数位序列是纬度序列。新字符串将转化为十进制并根据`base32`进行编码，从而达到使用一维数据代表二维的经纬度数据效果。当`GeoHash`首次划分地图时，经度分为`8`个部分，纬度分为`4`个部分，形成`32`个区域，之后根据奇偶校验位的交替变化，将每个区域交替分为4×8或8×4个区域。图1为划分过程。

【图1】

`Geohash`特殊的编码方式，使得一个`GeoHash`值对应一个近似矩形的覆盖区域，编码长度越长，区域范围越小，同时两个编码相近的区块在地理位置通常也距离十分相近。对地图数据进行区块绑定提供了极大的便利。

### `GeoHashTile`

`leaflet [31]`是用于地图的开源`JavaScript`库之一，它是`B / S`端`WebGIS`开发项目中广泛使用的开源软件。开发人员可以基于图书馆提供的接口进行开发和扩展，并实现地理信息服务的调用和地图数据的基本操作`[32]`。

 `Leaflet`强大的开源库插件涉及地图应用程序的各个方面，包括地图服务，数据提供，数据格式，地理编码，路线搜索，地图控制和交互等，并且还支持自定义控件的实现。这些控件丰富了`Leaflet`的功能`[33]`。本文是基于轻量级的`WebGIS`库`Leaflet`来完成的功能。

基于地理信息的应用程序，例如导航服务和电子出租车服务为日常生活提供了极大的便利并促进了个人移动设备的普及，为了获得更好的用户体验，有必要提高访问速度，同时确保有效信息的保留。在“访问速度”和视觉效果之间找到最佳的方法是通过划分、索引和压缩大型地图数据来减少数据传输和提高效率。在大多数文献中，传输的数据元素是携带经纬度坐标的矢量地图数据，如果使用一维字符代表经纬度，这是减少传输数据量的可行方法；另外，对于大多数平铺地图，网络空间索引是被认为是对大量数据访问的有效改进方法，但是，网络空间索引使用三字段查询，这使得在大量数据访问的情况下效率十分地下，第三，数据压缩的数据不会显著降低视觉效果。同时量化方法通过减少位数来压缩数据和实值坐标的精度，可以保持对象的拓扑关系，但是，当实现良好的视觉效果时，如何选择合理的数据量化尺度是一个亟待解决的问题。

`GeoHashTile`是基于`GeoHash`编码的地图数据显示方法，改进了传统地理数据显示在数据索引，数据压缩，以及不同粒度的预测。在此系统中，它使用`Geohash`编码系统代表坐标，并以此对大型地理数据进行分区和索引，数据压缩和图块编码也由`GeoHash`完成；它同时采用相对位置投影方法实现在`GeoHash`和屏幕像素坐标之间的直接转换，最后使用中间结果缓存的方法来提高计算和渲染效率。

`GeoHashTile`系统由两部分组成：服务器端和客户端，服务端提供矢量地理数据服务，客户端完成`GeoHash`矢量地理数据的显示，包括`GeoHashTile`计算过程，服务器地图数据的请求过程，`GeoHash`地图数据的投影过程以及中间结果缓存过程。该功能呢个框架如下：

服务器的工作分为两部分：`Geohash`矢量地理数据转换和`Geohash`矢量地理数据服务。数据转换负责将原始`GeoJSON`数据集的纬度和经度坐标转换为与缩放级别相对应的指定长度的`Geohash`编码的`GeoJSON`格式数据，并将数据重新组织为`GeoJSON`格式数据以供客户端访问，该数据还定义了数据访问接口并设置数据精度。收到客户端发送的HTTP请求后，数据服务部分将分解字段，查询相应的`Geohash`编码的`GeoJSON`数据，并通过HTTP响应将其返回给客户端，其中`Geohash`编码的矢量地理数据服务由`GeoServer`提供-基于Web的服务器。

客户端工作分为三个部分：第一步是计算与缩放级别z对应的`GeohashTile`的大小，命名为(gs_x，gs_y)；第二步是计算覆盖屏幕范围的`GeohashTile`的数量，名为`(gt_x，gt_y);`第三步是从中心的`GeohashTile`计算出相邻的`GeohashTile`以获得`GeohashTile`队列，同时计算出由每个点的中心点位置和相对像素中心点组成的两个队列，称为`gc_queue`和`gcp_queue`。同时客户端也是先了屏幕坐标位置和客户端上的`GeoHash`值的直接转换。

`GeoHashTile`以减少数据传输，提高索引效率和减少加载时间的目标出发，研究了基于`GeoHash`的矢量地理数据结构以及统一地图数据的`GeoHashTile`系统索引和几何坐标编码得以实现。`GeoHashTile`系统在减少用户的等待时间的同时不会影响显示效果，它使应用程序减少了数据传输和加载时间，它还提供了支持`GeoHash`编码的新矢量数据服务，实验结果表明，在减少数据量方面，由于`GeoHash`压缩了经纬度，不同级别的不同粒度地图数据的存储以及数据合并访问，因此`GeoHashTile`的平均表现要优于`GeoTile`的43.7%,web客户端上`GeoHashTile`的加载时间也比`GeoTile`短30.2%。

### 小结

## 地图信息存储

### 原理

### 改进

### 小结

## 树状区块链测试

### 总体框架和运行环境

### `GeoHash`地图信息存储

### `GeoHashTile`前端显示

### 车辆位置验证

## 系统测试

### 实验数据

### 分析与改进方向

### 本章小结

## 结论
## 参考文献
[Regional2019]R. Shrestha and S. Y. Nam, "Regional Blockchain for Vehicular Networks to Prevent 51% Attacks," in IEEE Access, vol. 7, pp. 95033-95045, 2019

[Intelligent2017]Zhang J , Gao W Z , Zhang Y C , et al. Blockchain Based Intelligent Distributed Electrical Energy Systems: Needs, Concepts, Approaches and Vision[J]. Zidonghua Xuebao/acta Automatica Sinica, 2017, 43(9):1544-1554.

[e-Health2019]L. Hirtan, P. Krawiec, C. Dobre and J. M. Batalla, "Blockchain-Based Approach for e-Health Data Access Management with Privacy Protection," 2019 IEEE 24th International Workshop on Computer Aided Modeling and Design of Communication Links and Networks (CAMAD), Limassol, Cyprus, 2019, pp. 1-7.

[Ocha2020]Ocha I S , Silva L A , Mello G D , et al. A Cost Analysis of Implementing a Blockchain Architecture in a Smart Grid Scenario Using Sidechains[J]. Sensors (Basel, Switzerland), 2020, 20(3).

Keying Huang, G.L.; Wang, J. Rapid retrieval strategy for massive remote sensing metadata based on

GeoHash coding. Remote Sens. Lett. 2019, 10, 111–119. [CrossRef]

Liu, J.; Li, H.; Yong, G.; Hao, Y.; Dan, J. A geohash-based index for spatial data management in distributed memory. In Proceedings of the International Conference on Geoinformatics, Kaohsiung,

Taiwan, 25–27 June 2014

Zhang, J.; Yang, C.; Yang, Q.; Lin, Y.; Zhang, Y. HGeoHashBase: An optimized storage model of spatial

objects for location-based services. Front. Comput. Sci. China 2018, 14, 208–218. [CrossRef]