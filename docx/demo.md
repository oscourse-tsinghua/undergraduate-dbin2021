# 基于树状区块链的地图信息存储和展现

# 引言

## 课题背景

随着智能车的发展与普及，车辆间的交互将变得必不可少，为了更好的利用蕴含在大量运行车辆中的信息并提供更加安全高效的交通环境，“车联网”随之而来。在“车联网”中，车载自组网`(Vehicular Ad-hoc Networks`，`VANETs)`占了重要地位。车辆或者路测节点以自组织的形式组成多跳网络进行数据交互，即车载自组织网络(简称车载自组网),催生了大量新的产品应用。基于车载自组网，交通参与者之间可以相互通信，形成移动Ad-Hoc网络，并提供去中心化、自组织的数据传输服务。

区块链技术是近年来兴起的一种全新的去中心化、分布式的计算框架。随着区块链技术的发展与普及，从其活跃的金融市场起，其高度重要性逐渐吸引了不同部门的组织的关注，从移动支付解决方案到医疗保健应用，`Blockchai`导致了成千上万的新工作岗位和新创业公司的发展。区块链最初是作为比特币的基础技术而开发的，它以其创建运行在数百万种设备上的庞大的，全球分布的分类帐的能力而迅速成名，该分类帐能够记录任何有价值的东西。区块链本质上是一种数字的，分布式的交易分类帐，在网络的每台成员计算机上维护着相同的副本。各方都可以查看以前的条目并记录新条目。区块链以轻松，自动化和分散的方式记录，存储和移动各种资产的能力引起了初创公司和整个金融服务行业的兴趣，它们正在设想在多个领域中可能的用例和应用程序。

目前，区块链与物联网领域结合的愈发紧密，区块链上部署相关合约，可以实现无需第三方见证的可信交易，并能够以相同的确定性实现相同的功能，区块链自身具有去中心化、分布式特性，这与车载自组网特性相符，将区块链技术运用到车载自组网中，能够利用其不可篡改性、可追溯性等安全特性，为车载自组网中的陌生节点信任问题提供一种解决方案。

车载自组网中有车辆结点快速移动性和车辆网络拓扑结构变化带来的不稳定性，同时，区块链的链式结构无法满足车载自组网应用对高并发操作和网络稳定性的需求。单链信息存储不能有效利用车载自组网中地理信息的区域化特性，另外，单链存储要求所有节点必须在同一区块链中，这将会导致节点数目和数据量巨大，不满足车载自组网中车辆节点的移动特性 ，为此，使用分片技术将单链改为树状区块链，增添位置信息，将是一种解决方式。 另外，车辆位置信息和地图信息在路由和安全应用中发挥着重要作用。攻击者可以通过位置欺骗达到利己的目的。利用区块链特性，方便多车辆协作，防止数据篡改，为位置信息等提供安全性保障，但在树状区块链上将地图信息和车辆位置信息进行存储和展示还需要进一步研究。

## 相关调研

### 区块链与智能合约
区块链是一种新型的那联网应用模式,它具备分布式、去中心化、集体维护、共识机制的特点，目前广泛应用于不同领域中。区块链，具体来说，是一个共享的不可更改的总账，它用于记录交易、跟踪资产以及建立信任。这些资产可以是有形的(房屋，汽车，现金，土地等)或者无形的(知识产权，专利，版权，品牌等)。几乎所有有价值的东西都可以在区块链网络上进行跟踪和交易，从而降低了风险并削减了所有相关人员的成本。交易业务依靠信息，收到的越快、越准确，就会越好。区块链是传递该信息的理想选择，因为它可以提供在不可更改的总账中的即时、共享且完全透明的信息，这类信息智能由获得许可的网络成员访问。另外，区块链网络也可以跟踪订单、付款、账户、生产等等。而且因为成员之间可以共享信息，所以成员可以查看到交易端到端的所有细节，从而带来更好的效率。
区块链有三个关键要素，分布式分类账技术、不可篡改以及智能合约。分布式分类账技术是指所有网络参与者都可以访问分布式分类账以及不可变的交易记录，且所有交易仅记录一次，从而消除传统业务网络中大量的重复工作和数据。不可篡改是指，区块链将交易记录到共享的分类账上后，任何网络参与者都无法更改或篡改该交易，如果交易中包含错误，则必须添加新交易来撤销该错误。
智能合约是存储在区块链上的程序，可以在满足预定条件的情况下运行，它们通常是自动执行的脚本，以便所有参与者无需任何中介机构的参与就可以立即结果，极大保证安全性。智能合约代码语句十分简单，当预定条件已经得到满足并完成验证时，区块链网络将执行对应动作，比如释放资金，发出凭证等，然后交易完成时更新区块链。由智能合约完成的交易也是无法更改的，只有获得许可的参与者才能看到结果。目前很多平台都实现了智能合约功能，使用的较多的还是以太坊上的智能合约。本文的课题也是基于以太坊来进行相关研究。

### 地理数据表示
随着移动用户的剧增，交互式信息地图服务需求正在逐渐增多，矢量数据地图正在兴起。在矢量地图数据中，矢量数据可以在所有放缩水平下以不同的颜色正确显示和区分特征，也正因如此使其正在快速发展。目前矢量地图主要利用`Web Map Tile Service(WMTS)`框架，它可以解决矢量数据分布不均和传输延迟长的问题，在此框架中，地图矢量数据需要被划分为图块，然后根据客户端的请求返回对应图块数据给客户端，通过它们各自的坐标在客户端重新组合，所以矢量数据的编码方式是影响其传输性能和可用性的关键因素。
`XML`和`JSON`是`web`应用程序中常用的两种矢量数据编码方法。`XML`(可扩展标记语言)是一种标记语言，用作`Internet`信息交换的标准。它具有良好的语义和可扩展性，并且可以灵活地表示数据，但由于`XML`使用重量级语法，因此会导致其格式复杂且大小较大，不利于上述地图数据传输。`JSON`是一种易于读写的轻量级数据表示格式，`GeoJson`是其中一种轻量级的数据表示方法，用于编码各类地理数据结构，可用于简单表示地理信息。
传统的矢量地图如`Google Maps`,采用二维数据经纬度来表示地理信息，这是一种球面坐标系统，当计算两点间距离时，要利用球面距离计算公式，涉及到复杂的三角函数，不便于计算。`Geohash`是一种新型的地址编码方式，它使用`Base32`编码成一维的字符串代替二维的经纬度数据。与`Google Maps`编码经纬度编码相比，`GeoHash`将二维空间查询转换为一维字符串匹配，利用此优势，`GeoHash`编码可以实现时间复杂度为`O(1)`快速查询。与`Bing Maps`相比，`GeoHash`编码使用`Base32`编码方法，同一前缀有32个不同子序列，而使用`Base64`的`Bing Maps`同一前缀下只有4个子序列。另外，基于`GeoHash`编码的空间索引算法具有对大量地理数据的高性能查询功能。当前，如`Google Maps`等主流地图产品采用经纬度表示地理数据坐标位置，而索引则采用另一种方法，`GeoHash`编码可以将二者结合起来，根据编码长度的不同，`GeoHash`可以同时表示图块的索引范围和坐标，从而可以实现统一编码。`GeoHash`编码同时给地理位置进行了分区，在位数较少时，它可以用来表示某一区域在地球上的坐标，在位数足够时，它也可以用来表示某个具体点在地球上的坐标。`GeoHash`在编码过程中保留了一定的相对地理位置信息，在大部分情况下，`GeoHash`编码共同前缀越长的区块物理距离越近。本文将`GeoHash`编码用于地图存储和区块链上。

### 车载自组网的区块链结构
传统区块链技术基于区块，整个网络同时只有一条单片，基于`PoW`共识机制出块无法并发执行，无法满足车载自组网对高并发操作和网络稳定性的需求，传统区块链也不具备移动性，无法与地理位置信息进行绑定，不能有效利用车载网中地理信息的区域化特性。另外，传统区块链的单链结构，要求所有节点必须在同一区块链中，这将会导致节点数目和数据量过大，不满足车载自组网中车辆节点的移动特性，且一旦出现网络分区，就会对整个区块链产生很大影响。目前采用分片技术更改原始单链的链式结构是解决上述问题的主流方法`[Global 2020]`
#### 多链结构
根据多链结构是否改变底层区块链结构可分为应用多链和结构多链。应用多链，即在应用层面建立不同功能的多个区块链，没有修改底层区块链结构。结构多链，即根据需求对区块链底层结构进行调整的多链结构。
##### 应用多链
`Zhang`等[Intelligent2017]提出了区块链群概念，即将区块链按照电力系统功能分为数据区块链、资产区块链、分析区块链、运营区块链以及支付区块链这5条独立运行的区块链。其中数据区块链为其他各个区块链提供文件服务结构，从分布式文件系统中读取所需数据，其他区块链的计算结果也可通过该接口写入数据区块链。
`[Regional2019]`研究了区域区块链在车载自组网中的应用，它是一个由物理边界区域内的节点共享的区块链。如果将区域区块链用于地理有限的区域，由于较小的传播延迟，可以极大减少到端到的消息延迟，提高区块链中节点交易效率，从理论上说，可以将整个区块链分为多个区域区块链，但该文仅从一个区域区块链内部进行了相关研究，并没有设计跨区域和跨链交易的相关内容。
[e-Health2019]提出了一种给予隐私保护的医疗保健系统，包含专用链和公用链两种区块链模型。专用链，即侧链，用于保存有关患者的真实身份信息；公用链，即主链，用于存储有关患者健康的信息以及标有临时ID的数据，从而实现了隐私数据保护和可用数据公开访问。通过特定节点掌握患者临时ID和真实身份的关联，来实现两个区块链数据的传递。
`[Ocha2020]`提出了一种使用侧链使智能电网具有可扩展性和适应性的区块链架构，将开放式智能电网协议`(OSGP)`集成三个区块链中，分别为`BlockPRI`、`BlockSEC`和`BlockTST`。其中，`BlockPRI`是用于存储每个用户的隐私，`BlockSEC`存储用户的数据，`BlockTST`管理和验证有关消费者-消费者和消费者-公司之间的能源贸易的信息。每个区块链对应一个功能，从整体上保证智能电网网络的隐私性和安全性。

##### 结构多链
结构多链是根据需求对区块链底层结构进行调整的多链结构，根据其组成特点，结构多链又可以分为并发多链和层次多链。并发多链结构扁平，各个子链可以根据需求负责相同或者不同的功能，相互之间地位平等。而层次多链属于多层级结构，至少具备上下层级关系的子链结构，各个层级负责的功能不同，地位也不同。
- 并发多链

  `[Monoxide]`提出异步共识区域，该区域在不影响分散性或安全性的前提下线性扩展了区块链系统。通过建立多个独立并行的单链共识区域来构成并发多链的区块链结构。各个共识组地位平等，大部分交易只在组内完成。分组按指定规则命名，跨组交易采用异步方式将中继事务发送到目标区域，而不是整个网络，减轻了网络负载。此外，为了确保每个区域中的有效采矿能力与整个网络处于同一水平，采用了`Chu-ko-nu`的改进`PoW`挖矿方式，这也同时保证了分组抵御攻击的能力。但其共识组分区方法没有考虑实际地理位置信息，不适用于车载自组网。

  `[RapidChain]`提出了基于分片的公共区块链协议，它将节点划分为多个较小的称为委员会的节点组，节点组在不相交的交易块上并行操作，并维护不相交的独立账本，也就是分片，分片由每个成员以区块链的形式存储。为了解决节点频繁移入移出对网络造成的映像，将委员会将分为活跃和不活跃两个分类，节点创建后，第一次进入委员会需要加入活跃类，再次进入或转移时需要加入不活跃类。`RapidChain`对分片和跨片交易处理，委员会重组，节点移动都有较好的处理，但也存在一些不足。委员会内节点数量固定，缺少灵活性；委员会构建和重构时没有考虑地理因素，增加了更新时间。
  
  `[Pruneable2018]`改进的`Rollerchain`中利用分片技术和`PBFT`（拜占庭式容错）算法提出了一种基于可分片的区块链协议`(PSRB)`。`PSRB`协议采用分片技术，使得`PoW`协商机制能够通过特定的社区分配规则和网络的分片功能实现事务的并发管理。社区分配规则为每个节点计算`PoW`难题，然后根据其`nonce`分配给某个社区。与现有的区块链协议不同，`PSRB`协议在每个节点和主链只存储区块头链和部分区块时，保证了系统的安全性，避免了协议的体积膨胀和容量膨胀问题。由于`nonce`计算的随机性，会出现社区内节点数目差别过大的问题，该方法没有说明对节点处理的方法。
  
- 层次多链

  `[Byung2018]`将物联网与基于区块链的智能合约相结合，用于结构健康监视`(SHM)`，定义新颖，高效，可扩展和安全的分布式网络，增强运营安全性。该在这个区块链物联网网络中，通过将本地集中和全球分散的分布分为核心和边缘网络，激活了本地集中和全球分散分布的特征，并提供了本地数据库的原始数据存储和核心区块链网络的结构事件存储两种类型的存储。边缘节点充当查询实时响应的集中式服务器，并提供低延迟和带宽使用率，核心网络由具有高存储容量的`miner`节点组成，负责生成新块、验证工作证明`（PoW）`，并包含用于自主决策的智能合约，这种划分提高了系统的效率和可伸缩性且可以有效地模拟结构的自主监测和控制，但核心网络十分庞大是主要问题 。

  `[LightChain2019]`为解决部署区块链和处理事务负担过大，提出了`LightChain`的轻量级区块链系统，该系统由`API`层，`LightChain`层， 缓存层和存储层等4层框架构成。`API`层用来读写本地数据和构造区块链交易；`LightChain`层通过数字签名验证和附件验证用来验证交易的有效性和完整性；缓存层是为了加速对调用的响应而设计的，它包含本地操作、未验证的块和有用的块；存储层通常由资源丰富的设备提供服务，为上层提供持久存储服务。其中，`LightChain`层采用模块化设计，又分为`Webchain`、`Conchain`和`Chainbase`三个协作模块。`Webchain`是`LightChain`层的前端，它将`API`层发送的操作类型和`JSON`流转换为预定义的消息类型和内部处理的二进制流；`Conchain`充当共识和`P2P`网络模块。除了执行基于`SMP`的一致性计算之外，它还负责管理对等列表并与它们建立`TCP/IP`连接；`Chainbase`是`LightChain`层的后端，拥有添加、过滤或卸载缓存层缓存的本地分类帐数据的权限。该方法只是将区块链的计算和存储功能分开，未对节点、交易等进行分片或分类。

  `[Multi2021]`提出了一种多层区块链安全模型来保护物联网网络，同时简化了实施过程。为了便于多层体系结构的实现，采用了聚类的概念。在物联网网络中，采用模拟退火和遗传算法相结合的混合进化算法来定义K-未知簇。所选的集群头负责本地身份验证和授权。本地私有区块链的实施促进了集群头和相关基站之间的通信。这样的区块链增强了可信性保证和安全性，同时还提供了网络认证机制。

  `[Blockchain2018Chao]`提出了一个具有分层、交叉和自组织区块链结构`（BCS）`的框架，以建立物联网和区块链之间的关系来验证设备可信度。工作内容包括三个部分：首先，该框架由多个不同层次的区块链组成，上层的区块链节点管理一个下层的区块链，不同的区块链网络可以构成一个层次关系。其次，底层的寄存器数据依次传输到上层区块链节点，并记录在路径中的每个区块链中。最后，可信度验证过程是沿着源设备到目标设备的验证链。该方法中没有对管理节点的选择方法和数量进行研究；同时其可信度验证需要沿层级结构传递，如何合理的设定层级结构的高度或者优化传递路径是有待解决的问题。

  `[Sharma2018]`利用软件定义网络和区块链技术的优势，提出了一种新的智能城市混合网络体系结构。该模型利用区块链技术将智能城市网络分为核心网络和边缘网络。核心网络由具有高计算和存储资源的`miner`节点组成，而边缘节点的存储和计算能力有限。边缘节点根据需要将预处理后的加密数据传输到智慧城市核心网，`Miner`节点将负责创建块和验证工作证明。每个节点都采用`SDN`控制器，实现了高度的灵活性和安全性，降低了硬件管理成本，实现了智能城市网络基础设施的易部署性。通过混合体系结构的设计，文章提出的体系结构继承了集中式和分布式网络体系结构的优点。该结构仅对节点进行分类，并未对区块链的交易和状态进行划分。

  `[Mbs2019]`提出了一个多级区块链框架，以增强物联网应用中的隐私和数据安全。多层次模型侧重于提高响应时间和资源利用率。方案中定义了移动代理来执行哈希函数、实现加密、部署聚合和解密。移动代理在区块链和物联网之间传输，以完成所需的任务。该多层次框架由微观层次（物联网设备层次）、中观层次区块链（物联网的簇头层次）和宏观层次区块链（平台层次或物联网的最高层次）等三层次组成。

  `[Hierarchical2020]`提出了一个可扩展的物联网双层分层区块链体系结构。第一层是基于实用拜占庭容错`（PBFT）`共识来处理高吞吐量的核心引擎，第二层分别由支付引擎、计算引擎和存储引擎组成，用来管理底层的从属引擎（子引擎）。支付引擎负责所有物联网小额支付；计算引擎控制智能合约计算并执行物联网处理逻辑；存储引擎管理物联网数据存储；核心引擎为所有其他引擎的父引擎，起到控制和协调作用。作者将这些子引擎的多个实例部署到尽可能多的位置，并尽量靠近物联网设备所在的物联网域，以应对大量节点。此外，为了进一步扩展所提出的体系结构的可伸缩性，作者还在核心引擎上提供了额外的可伸缩性特性，如请求聚合、请求优先级以及子引擎并行性。该结构按照功能划分子区块链，很好的起到并发执行的效果。但是划分时未考虑物联网设备的地理位置因素，可能会引起远程调用的问题。

## 论文的研究内容及贡献

准备阶段，作者通过复现出李炜琪、张禹等人工作，熟悉了区块链的相关知识。本文中，作者完成了使用`GeoHash`编码转码地图数据，并将其存储至传统区块链上，并通过`GeoHashTile`前端将地图数据进行呈现，最后成功在此基础上完成车辆位置验证以及信誉评估的相关测试。由于传统区块链全局同步与共识速度的限制导致其不能很好的适应车载自组网的高动态性以及与地理位置相关的特征，极大影响区块链在车载自组网中的应用，并且不能报这个车辆与路测节点的稳定连接，影响区块链的可用性与可靠性。为此，将上述工作全部移植到树状区块链上，保证工作的正确性，最后对树状区块链进行了一些测试工作。

# 地图信息存储

车辆位置信息和地图信息在路由和安全应用中发挥着重要作用。攻击者可以通过位置欺骗达到利己的目的。利用区块链特性，方便多车辆协作，防止数据篡改，为位置信息等提供安全性保障。在本章中，作者将介绍如何将地图数据处理为`GeoHash`编码，并实现区域绑定，最终将其存入区块链上。

## 原理

### 区块链

区块链具有去中心化、分布式、点对点、集体维护等特点，其上交易的不可更改性保证了数据的可靠性，通过编写智能合约，将地图数据存入区块链，可以使得移动端用户获取安全正确的数据，且稳定性更高，更有利于车载终端互连。

传统的地图数据采用经纬度的方法进行存储，不方便实现位置与区域绑定，另外，在智能合约语言Solidity的限制下，智能合约中不方便构建树状结构体，采用`GeoHash`字符串存储地图信息可以是所有信息平面化，避免使用树状结构，同时，根据`GeoHash`编码规则,一个`GeoHash`值所代表的区域一定包含以该`GeoHash`值为前缀的所有元素。

### `Web3Js`

前端使用`web3js-v1.2.29`调用，首先需要`Web3.providers.HttpProvider`绑定监测`IP`：

```javascript
web3Map = new Web3(new Web3.providers.HttpProvider(mapContractServer));
```

然后使用`eth.Contract`绑定对应合约：

```javascript
mapContract = new web3Map.eth.Contract(mapContractAbi,mapContractAddress);	
```

其中`mapContractAbi`是合约接口，`mapContractAddress`是合约部署到区块链上的地址

在与合约进行交易的时候，需要调用`methods`下的`call`和`send`方法，如果是发送交易，需要更改区块链数据则调用`send`方法：

```javascript
trafficContract.methods.setSinglePos(userId, locTime[index], latOri, lonOri, latFix, lonFix).send({from: trafficContractAccount, gas: 500000});
```

如果是获取区块链上的数据则使用`call`方法:

```javascript
trafficContract.methods.getQuality(userId).call(function(error, result){
		if(!error) {
			console(result);
        	} else
		console.error(error);
});
```

## 实现思路

### 数据转换

原始数据为`GeoJson`的经纬度格式，如下：

```json

```

编写`JS`脚本将对应坐标数据转化为`GeoHash`编码：

```json

```

### 绑定方法

在存储地图时，本文将地图划分为精度较低、范围较广的`GeoHash`块，并实现对应区域中元素与块实现一一绑定，因此想要请求某一区域的地图信息时，只需要通过该区域对应的`GeoHash`编码值查找。完整的地图数据主要有三种元素：点，道路，建筑物。

在进行绑定时，点只需要绑定到前缀所代表的区域上，如图

【点绑定区域】

对于道路，地图数据中以矢量的形式出现，取其起点和终点，将其当作一条直线，对于经纬度，`0.01°`经度代表`1000m`，`0.01°`纬度代表`1113m`，所以通过遍历从起点到终点的经纬度，以0.01°为间隔，划分出对应区域，然后通过前缀判断是否有交叉，从而判断该直线是否在该区域内。如图

【直线绑定区域】

对于建筑物，地图数据中建筑物是多边形数据，且建筑物一般横跨区域不大，所以通过遍历多边形上的点元素，将其绑定到前缀所对应的区域上，即可完成建筑物绑定。

【建筑物绑定】

### 地图存储合约

合约里面，首先构建了存储一条地图信息的结构体：

```solidity
```

对于每条地图数据会有对应的`gid`编号，通过`mapping`完成区域与区域内信息的映射。如下：

```json

```

## 小结

# 基于`GeoHash`地图显示

本章主要对`GeoHash`进行介绍，第一小节介绍`GeoHash`编码原理，第二小节介绍`GeoHashTile`原理。

## 简介

`Geohash `是由 `Gustavo Niemeyer` 和 `G.M. Morton` 发明的一种地理编码系统,它将地理位置编码为一个固定长度的字符串,被广泛应用于基于地理位置的应用中。`GeoHash`是一种新型的地址编码方式，它将经度和纬度分别转换成一组二进制字符串，然后将经度和纬度的二进制字符串交叉结合成一组新的二进制字符串，新的二进制字符串中对应偶数位的序列是经度序列，对应奇数位的序列是纬度序列，然后将新字符串转为十进制并根据`base32`(即数字0-9和字母b-z不包括a,i,l,o的32个字符)进行编码，最终实现用一维数据表示二维数据的效果。当`GeoHash`首次划分地图时，经度分为`8`个部分，纬度分为`4`个部分，形成`32`个区域，之后根据奇偶校验位的交替变化，将每个区域交替分为4×8或8×4个区域。图1为划分过程。

【图1】

`Geohash`特殊的编码方式，使得一个`GeoHash`值对应一个近似矩形的覆盖区域，编码长度越长，区域范围越小，同时两个编码相近的区块在地理位置通常也距离十分相近。对地图数据进行区块绑定提供了极大的便利。`GeoHash`编码同时给地理位置进行了分区，在位数较少时，它可以用来表示某一区域在地球上的坐标，在位数足够时，它也可以用来表示某个具体点在地球上的坐标。`GeoHash`在编码过程中保留了一定的相对地理位置信息，在大部分情况下，`GeoHash`编码共同前缀越长的区块物理距离越近。

本文后面将具体介绍如何将地图数据存储为`GeoHash`编码，并使用`GeoHashTile`前端展示出来。

## 基于`GeoHash`的矢量地图展示

`leaflet [31]`是用于地图的开源`JavaScript`库之一，它是`B / S`端`WebGIS`开发项目中广泛使用的开源软件。开发人员可以基于图书馆提供的接口进行开发和扩展，并实现地理信息服务的调用和地图数据的基本操作`[32]`。

 `Leaflet`强大的开源库插件涉及地图应用程序的各个方面，包括地图服务，数据提供，数据格式，地理编码，路线搜索，地图控制和交互等，并且还支持自定义控件的实现。这些控件丰富了`Leaflet`的功能`[33]`。本文是基于轻量级的`WebGIS`库`Leaflet`来完成的功能。

基于地理信息的应用程序，例如导航服务和电子出租车服务为日常生活提供了极大的便利并促进了个人移动设备的普及，为了获得更好的用户体验，有必要提高访问速度，同时确保有效信息的保留。在“访问速度”和视觉效果之间找到最佳的方法是通过划分、索引和压缩大型地图数据来减少数据传输和提高效率。在大多数文献中，传输的数据元素是携带经纬度坐标的矢量地图数据，如果使用一维字符代表经纬度，这是减少传输数据量的可行方法；另外，对于大多数平铺地图，网络空间索引是被认为是对大量数据访问的有效改进方法，但是，网络空间索引使用三字段查询，这使得在大量数据访问的情况下效率十分地下，第三，数据压缩的数据不会显著降低视觉效果。同时量化方法通过减少位数来压缩数据和实值坐标的精度，可以保持对象的拓扑关系，但是，当实现良好的视觉效果时，如何选择合理的数据量化尺度是一个亟待解决的问题。为此，`GeoHashTile`很好的解决了此类问题。

### `GeoHashTile`简介

`GeoHashTile`是基于`GeoHash`编码的地图数据显示方法，改进了传统地理数据显示在数据索引，数据压缩，以及不同粒度的预测。在此系统中，它使用`Geohash`编码系统代表坐标，并以此对大型地理数据进行分区和索引，数据压缩和图块编码也由`GeoHash`完成；它同时采用相对位置投影方法实现在`GeoHash`和屏幕像素坐标之间的直接转换，最后使用中间结果缓存的方法来提高计算和渲染效率。

### `GeoHashTile`架构

`GeoHashTile`系统由两部分组成：服务器端和客户端，服务端提供矢量地理数据服务，客户端完成`GeoHash`矢量地理数据的显示，包括`GeoHashTile`计算过程，服务器地图数据的请求过程，`GeoHash`地图数据的投影过程以及中间结果缓存过程。该功能框架如下：

服务器的工作分为两部分：`Geohash`矢量地理数据转换和`Geohash`矢量地理数据服务。数据转换负责将原始`GeoJSON`数据集的纬度和经度坐标转换为与缩放级别相对应的指定长度的`Geohash`编码的`GeoJSON`格式数据，并将数据重新组织为`GeoJSON`格式数据以供客户端访问，该数据还定义了数据访问接口并设置数据精度。收到客户端发送的HTTP请求后，数据服务部分将分解字段，查询相应的`Geohash`编码的`GeoJSON`数据，并通过HTTP响应将其返回给客户端，其中`Geohash`编码的矢量地理数据服务由`GeoServer`提供-基于Web的服务器。

客户端工作分为三个部分：第一步是计算与缩放级别z对应的`GeohashTile`的大小，命名为(gs_x，gs_y)；第二步是计算覆盖屏幕范围的`GeohashTile`的数量，名为`(gt_x，gt_y);`第三步是从中心的`GeohashTile`计算出相邻的`GeohashTile`以获得`GeohashTile`队列，同时计算出由每个点的中心点位置和相对像素中心点组成的两个队列，称为`gc_queue`和`gcp_queue`。同时客户端也是先了屏幕坐标位置和客户端上的`GeoHash`值的直接转换。

### `GeoHashTile`优点

`GeoHashTile`以减少数据传输，提高索引效率和减少加载时间的目标出发，研究了基于`GeoHash`的矢量地理数据结构以及统一地图数据的`GeoHashTile`系统索引和几何坐标编码得以实现。`GeoHashTile`系统在减少用户的等待时间的同时不会影响显示效果，它使应用程序减少了数据传输和加载时间，它还提供了支持`GeoHash`编码的新矢量数据服务，实验结果表明，在减少数据量方面，由于`GeoHash`压缩了经纬度，不同级别的不同粒度地图数据的存储以及数据合并访问，因此`GeoHashTile`的平均表现要优于`GeoTile`的43.7%,web客户端上`GeoHashTile`的加载时间也比`GeoTile`短30.2%。

## 总体测试框架和运行环境

### 测试环境

本次测试，使用`nvm-v0.37.2`管理`nodejs`版本，使用`npm-v6.14.11`包管理，智能合约语言使用`Solidty-v0.5.16`,在前端调用合约方法上，使用`web3js-v1.2.9`与之进行交互。在对合约 进行测试时，采用`ganache-cli`提供本地临时区块链私有链服务，并使用`Truffle-v5.1.62`辅助部署智能合约，简化了开发和测试流程。在正式应用上，采用`geth-v1.9.12`以太坊客户端，部署本地私有链，存储相关信息。因为本文应用均是基于最新的开发环境，在编写合约和测试过程中遇到过很多问题，因此编写了许多有关环境配置以及简单示例文件的相关帮助手册，希望能为其他人提供帮助。

### 测试流程

为了验证地图存储的正确性，本文将此工作与前人相关工作合并，使用`GeoHashTile`前端对地图数据进行展示，且在此基础上，运行李炜琪车辆位置验证系统。

随着区块链的普遍应用，对应平台也逐渐增多，主流平台还是以太坊。此测试也是在该平台进行相关操作，总体测试流程如下：

- 首先建立`Geth`私有链

  - 建立私链首先需要构建创世块,如下是我所使用的创世块`genesis.json`

    ```bash
    {
      "config": {
        "chainId": 666,
        "homesteadBlock": 0,
        "eip150Block": 0,
        "eip150Hash": "0x0000000000000000000000000000000000000000000000000000000000000000",
        "eip155Block": 0,
        "eip158Block": 0,
        "byzantiumBlock": 0,
        "constantinopleBlock": 0,
        "petersburgBlock": 0,
        "istanbulBlock": 0,
        "ethash": {}
      },
      "nonce": "0x0",
      "timestamp": "0x5ddf8f3e",
      "extraData": "0x0000000000000000000000000000000000000000000000000000000000000000",
      "gasLimit": "0x47b760",
      "difficulty": "0x00002",
      "mixHash": "0x0000000000000000000000000000000000000000000000000000000000000000",
      "coinbase": "0x0000000000000000000000000000000000000000",
      "alloc": { },
      "number": "0x0",
      "gasUsed": "0x0",
      "parentHash": "0x0000000000000000000000000000000000000000000000000000000000000000"
    
    ```

  - 初始化私链

    ```bash
    geth init ./genesis.json --datadir "./chain"
    ```

    之后所有私链上的相关信息都将保存至`chain`文件夹中。

  - 启动私链

    ```bash
    geth --identity "etherum" --rpcaddr 127.0.0.1 --rpc --rpcport "8545" --rpccorsdomain "*"  --maxpeers 2 --rpcapi "personal,eth,net,web3,debug" --networkid 100 --datadir "./chain" --nodiscover --allow-insecure-unlock --dev.period 1 console
    ```

    由于`GeoHashTile`前端使用`html`编写，通过`web3`与合约进行交互，为此，需要开启`rpc`选项，并指定对应端口，才能正确访问合约。

- 通过`truffle`工具可以简单部署合约到区块链上

- 通过`JS`脚本将地图数据进行上传及绑定

- 等所有数据上传完毕后，使用`GeoHashTile`前端对其信息进行展示,运行车辆位置验证及信誉评估系统，主要流程如下：

  - 系统初始化。此时私有链和合约已经初始化完毕，在浏览器端，程序需要初始化`web3js`接口，通过合约地址和`ABI`(合约接口)链接到私有链上的合约。为了在浏览器配合本地缓存生成用户的通用唯一识别码`(UUID)`,使用该识别码可以避免绝大情况下的用户名冲突。

  - 获取对应`GeoHash`区域的所有地图信息。浏览器通过`web3js`调用合约对应函数，从而抓取返回结果，并更新地图信息。

    【结果图】

  - 运行李炜琪评估系统

    【结果图】

## 小结

`GeoHash`编码使用一维数据替代了二维经纬度数据，同时给地理位置进行了分区，在位数较少时，它可以用来表示某一区域在地球上的坐标，在位数足够时，它也可以用来表示某个具体点在地球上的坐标。在` GeoHash `精度取 8 位的情况下已经可以基本满足代替传统

经纬度坐标作为车辆位置精确表示的需求，且若只考虑中国所处纬度（3°51′N 至

53°33′N），精度将会提高。考虑到车辆位置验证以及道路匹配需要更高的精准度，所以之后的工作中采用了`11`位长度的`GeoHash`编码。[李炜琪]

`GeoHashTile`提高了 矢量地图的索引效率和加载时间，且提供了支持`GeoHash`编码的新矢量数据服务。

测试表明，目前该系统可以成功将地图数据经纬度格式转为`GeoHash`格式，并上传到以太坊私链进行保存。

# 树状区块链应用与测试

## 背景介绍

​	车辆或者路测节点以自组织的形式组成多跳网络进行数据交互，即车载自组织网络(简称车载自组网，`Vehicular Ad-hoc Networks`，`VANETs`),催生了大量新的产品应用[1]。在其基础之上，车辆与行人、基础设施以及因特网的通讯使其概念扩大为"车联网"(`Internet of Vehicles，IoV`)[2]。在车联网概念中包含了车载自组网和蜂窝网络这两种不同的接入方式，车载自组网因其低基础设施成本、低时延以及与地理位置天然联系的特性，是蜂窝网络接入的重要补充，在道路安全和边缘计算等关键应用中提供了重要支撑 [3]。

​	随着智能车辆数量的大幅增加，车辆与车辆或固定设施之间的信息交互越来越多，因此数据安全、隐私、信任问题成为了重要问题之一 [4]。区块链作为一种分布式账本技术，具有去中心化、抗抵赖、可追溯等特点，已被很多工作引入到车联网中，但还存在多方面的问题 [5]。其中包括两方面：首先，因为区块链技术要求可靠的网络接入，已有工作通常假定稳定的基础设施网络接入，存在网络覆盖以及基础设施成本问题。而使用车载自组网的接入方式则因其网络高动态性对区块链技术的引入造成了很大的挑战：例如网络不稳定（断连、递交率低等）引发的抵赖或双花问题。其次，车载自组网中的信息通常与地理位置绑定，车辆仅对特定地理区域内的信息感兴趣。而区块链全局同步、共识速度的限制等特点导致其不能天然适用于高动态的车载自组网。因此，研究地理位置与区块链的融合就是为上述地理区域问题提供一种可能的解决方案。

## 相关工作

​	一方面，传统区块链吞吐量较小、出块速度慢，需要改善它的结构来提升可扩展性；另一方面，传统区块链与真实世界的联系较弱，而车联网与地理信息有天然联系并且紧密相关，因此传统区块链结构不能很好适应车联网 [54]。一种主流的解决方案是将区块链的单链结构改良为多链结构。根据多链结构的构成方式的不同，可以将相关工作分为三类：并发多链 [37–40]，层次多链 [41–45]，智能合约多链 [46, 47]。并发多链存在多条子链，每条子链对应一个独立的功能模块，主链只负责维护多条子链的数据一致性；层次多链中，区块以层次化的结构组成区块链，各个层级具有上下从属关系；智能合约多链与并发多链结构类似，区别在于智能合约多链不修改区块链数据结构，通过智能合约维护多链数据一致性，存在多链数据同步的效率以及地理信息相关数据的存储以及检索的问题。目前还没有将地理位置融合进区块链数据结构实现层次化多链的工作。

## 研究内容及原理

​	区块链全局同步与共识速度的限制导致其不能很好的适应车载自组网的高动态性以及与地理位置相关联的特征，极大影响了区块链的效能(如区块链维护开销、车辆交易或其他信息录入区块链的速度)，并且不能保证车辆与路测节点的稳定连接这个特征会影响区块链共识机制的可用性与可靠性。

​	树状区块链的研究就是为了对区块链的适应性进行修改与优化，使其更能适应车载自组网特性。基于位置的区块链，根据地理编码与地理区域层次的天然关系建立树状结构的区块，同时研究树状结构中地理信息相关数据查询速度的优化机制，从而提升区块链在车载自组网中的吞吐量以及与地理信息相关数据的检索速度。车载自组网与地理信息有天然的联系，并且车辆通常只关注特定区域内的信息，因为可以基于地理信息将区块链划分为都欧联来解耦全局的区块链数据同步，并增加区块链与真实世界的关联。另外，传统区块链记录的交易信息不包含位置，无法根据地理区域查询交易，且传统区块链全局同步的设计会造成网络资源的大量浪费，并且传统区块链只能方便查询某个账户的交易、最新的交易、指定区块内包含的交易，无法高效的查询地理信息相关的数据，因此亟需解决位置与区块数据结构的融合与树状结构的构建方法，以及树状结构中与地理信息相关信息查询速度的优化问题。

​	基于`GeoHash`地理编码建立树状区块链，建立`GeoHash`与区块以及交易的索引，`GeoHash`是一个能表示任意精度的高效地理编码系统，它使用二分法将指定区域分为网格，每个网格由唯一的编码表示，网络的大小对应的层次不同，编码越长对应的 网格越小，层次越低，因此基于`GeoHash`编码可以很自然地建立区域层次与子链的链接。

树状区块链主要包括三个部分的工作：更改区块数据结构、区块与节点的层次化分类以及区块的层次化组织。

- 区块数据结构

  如图所示，树状区块链是基于以太坊的区块链数据结构进行修改的，在其基础上主要新增如下数据结构：

  - 同层块指针：记录与本区块同层次地理区域对应区块的哈希，与父块哈希一同 构成树状区块链
  - 位置：使用指定长度的 `Geohash` 编码表示位置，分别在账户状态、交易数据中新增位置信息，增加账户、交易与物理世界的关联。
  - 区域状态树：以`Geohash`作为索引构建字典树，存储区域内的四种信息：当前区域内的账户（Account）、交易（`TXID`）、收据（`RPID`）以及上层区域状态树根节点列表（`URRList`）记录所有上层区域状态树的根节点哈希。
  - 账户位置树：在外部账户的账户状态中以发生交易时的，记录账户发生过的交易所在的区域。可以提供以下功能：根据位置区域，查询该区域内最新交易；查询某个账户在指定区域的交易以及历史交易发生的位置。

  ![image-20210515204202217](C:\Users\X1TABLET\AppData\Roaming\Typora\typora-user-images\image-20210515204202217.png) 

- 区块与节点的层次化分类

  为了将区块链划分为树状结构，首先将区块按其特征分为三种：

  - 创世块：区块链的初始区块。
  - 分支块：根据 Geohash 编码以层次化结构一一对应创建分支区块作为对应区域内子链的头区块，只维护直接下层区域的索引信息，不记录交易信息。
  - 普通块：地理区域的最小划分（最下层）对应分支区块的子区块，记录在对应地理区域内发生的交易。

  其次，将网络节点按照其功能分为三种：

  - 全节点：维护全区块链完整区块数据和全局状态树，部分服务器为全节点。
  - 区域节点：维护其所在区域内指定层次及以下的所有分支区块与普通区块。每个分支节点负责向上层节点更新汇总当前区域状态并同步所有上层区块链的区域状态树根节点列表。路侧节点与部分服务器为区域节点。
  - 叶节点：维护所在区域内最下层分支区块以及普通区块。负责局部共识，以及在与区域节点有连接机会时上传缓存信息，并同步所有上层区块链的区域状态树根节点列表。车辆节点为叶节点。

- 区块的层次化组织

  在拟提出树状区块链设计中，只有普通区块会记录实际发生的交易，分支区块提供的是子区块链头区块（最下层地理分区）以及索引的功能（中间层次地理分区）。在最下层的每个地理区域都对应一个分支区块和多个普通区块通过父块哈希指针（`ParentHash`）组成的区块链，同层次不同区域对应的分支区块之间通过同层块指针（`ParaHash`）链接起来。分支区块的上下层代表地理区域的包含关系，即上层分支区块对应的地理区域包含所有以该区块为父块的下层区块对应的地理区域。除最下层以外其他层次区域对应的分支区块会在其区块头的四个状态树中同步更新与其直连的下层所有区块数据的哈希索引，以方便区块数据的查询。

树状区块链与传统区块链相比，融合了地理位置，增加了区块链与真实世界的联系，设计了区块状态数和账户位置树提升与地理信息相关数据的检索速度。

## 目前工作

### 移植地图存储与展现

- 首先替换树状区块链客户端

- 在此基础上建立私链，加上地理位置信息，创世块如下：

  ```json
  
  ```

- 初始化树状区块链私链

  ```javascript
  geth --identity "MyEth" --rpc --rpcaddr 127.0.0.1  --rpcport "8545" --rpccorsdomain "*" --datadir gethdata --port "30303" --nodiscover --rpcapi "eth,net,personal,web3" --networkid 91036 init genesisgtrie.json
  ```

- 启动树状区块链私链

  ```javascript
  geth --identity "MyEth" --rpcaddr 127.0.0.1 --rpc --rpcport "8545" --rpccorsdomain "*" --datadir gethdata --port "30303" --nodiscover --rpcapi "eth,net,personal,web3" --networkid 91036 --allow-insecure-unlock --dev.period 1 console	
  ```

- 合约不能直接使用`truffle`进行部署，由于增添了位置信息，应该直接在`geth`客户端上进行部署,部署样例如下：

  ```javascript
  //部署合约contract在移动区块链上
  abi = JSON.parse('')
  bytecode = ""
  InstanceContract = web3.eth.contract(abi);
  web3.eth.estimateGas({data: bytecode})
  Instance = InstanceContract.new({
      from: web3.eth.accounts[0], 
      data: bytecode, 
      gas: '1400000',
      position:"w25111111111113",
      txtime:277001
    },function (e, contract){
      console.log(e, contract);
      if(!e){
          if(!contract.address) {
              console.log("Contract transaction send: TransactionHash: " + contract.transactionHash + " waiting to be mined...");
          } else {
              console.log("Contract mined! Address: " + contract.address);
              console.log(contract);
          }
      }
  });
  ```

- 通过`JS`脚本将地图数据进行上传及绑定

- 结果展示

  与传统区块链相比，结果基本一致，证明树状区块链基础功能正确。

### 测试

- 吞吐量对比
  - 和比特币7tps、以太坊25tps比较。
  - 交易确认时间对比。平均一笔交易的确认时间
- 区块大小。相同交易内容，交易数量，打包入同一区块。对比用合约存位置和用LQTChain存数据的区块大小。（单链合约存储，单链LQTchain存储，多链LQTchain存储）
- 区块生成时间。两种系统的区块生成时间。（单链合约存储，单链LQTchain存储，多链LQTchain存储）
- 查询时间对比。（单链合约存储，多链合约存储，多链LQTchain存储）
  1. 多范围尺度查询时间对比
  2. 有无结果缓存查询时间对比。
- 账户历史轨迹查询时间对比。
  1. 查询账户指定时间段轨迹时间（合约查询和ALT查询）
  2. 账户在指定区域出现时间的查询时间（合约查询和区域状态树查询）

## 小结

# 结论
# 参考文献
[Regional2019]R. Shrestha and S. Y. Nam, "Regional Blockchain for Vehicular Networks to Prevent 51% Attacks," in IEEE Access, vol. 7, pp. 95033-95045, 2019

[Intelligent2017]Zhang J , Gao W Z , Zhang Y C , et al. Blockchain Based Intelligent Distributed Electrical Energy Systems: Needs, Concepts, Approaches and Vision[J]. Zidonghua Xuebao/acta Automatica Sinica, 2017, 43(9):1544-1554.

[e-Health2019]L. Hirtan, P. Krawiec, C. Dobre and J. M. Batalla, "Blockchain-Based Approach for e-Health Data Access Management with Privacy Protection," 2019 IEEE 24th International Workshop on Computer Aided Modeling and Design of Communication Links and Networks (CAMAD), Limassol, Cyprus, 2019, pp. 1-7.

[Ocha2020]Ocha I S , Silva L A , Mello G D , et al. A Cost Analysis of Implementing a Blockchain Architecture in a Smart Grid Scenario Using Sidechains[J]. Sensors (Basel, Switzerland), 2020, 20(3).

Keying Huang, G.L.; Wang, J. Rapid retrieval strategy for massive remote sensing metadata based on

GeoHash coding. Remote Sens. Lett. 2019, 10, 111–119. [CrossRef]

Liu, J.; Li, H.; Yong, G.; Hao, Y.; Dan, J. A geohash-based index for spatial data management in distributed memory. In Proceedings of the International Conference on Geoinformatics, Kaohsiung,

Taiwan, 25–27 June 2014

Zhang, J.; Yang, C.; Yang, Q.; Lin, Y.; Zhang, Y. HGeoHashBase: An optimized storage model of spatial

objects for location-based services. Front. Comput. Sci. China 2018, 14, 208–218. [CrossRef]

[Global 2020] Liu Xizi. Global blockchain technology and application innovation status, trends and enlightenment[J]. Science & Technology China, 2020(1): 27-31

[Kalman2020] LIU C,ZHANG G,GUO W,etal． Kalman Prediction-Based Neighbor Discovery and Its Effect on Routing Protocol in Vehicular Ad Hoc Networks[J]．IEEE Transactions on Intelligent Transportation Systems,2020,21(1):159-169.

[Monoxide] Monoxide: Scale out Blockchains with Asynchronous Consensus Zones. NSDI'19: Proceedings of the 16th USENIX Conference on Networked Systems Design and Implementation. February 2019. Pages 95–112.

[Byung2018]Byung, Wan, Jo, et al. Hybrid Blockchain and Internet-of-Things Network for Underground Structure Health Monitoring.[J]. Sensors, 2018.

[RapidChain]M. Zamani, M. Movahedi, and M. Raykova, “RapidChain: Scaling blockchain via full sharding,” in Proc. ACM SIGSAC Conf. Comput. Com-mun. Secur., New York, NY, USA, pp. 931–948.2018.

[Pruneable2018]Feng X , Ma J , Miao Y , et al. Pruneable sharding-based blockchain protocol[J]. Peer-to-Peer Networking and Applications, 2018.

[LightChain2019]Liu Y , Wang K , Lin Y , et al. LightChain: A Lightweight Blockchain System for Industrial Internet of Things[J]. IEEE Transactions on Industrial Informatics, 2019, 15(6):3571-3581.

[Multi2021]Pajooh H H , Rashid M , Alam F , et al. Multi-Layer Blockchain-Based Security Architecture for Internet of Things[J]. Sensors, 2021, 21(3):772.

[Blockchain2018Chao]Chao Q , Ming T , Jie Z , et al. Blockchain Based Credibility Verification Method for IoT Entities[J]. Security & Communication Networks, 2018, 2018:1-11.

[Sharma2018]Sharma P K , Park J H . Blockchain based hybrid network architecture for the smart city[J]. Future Generation Computer Systems, 2018:650-655.

[Mbs2019] Mbarek, B.; Jabeur, N.; Pitner, T. Mbs: Multilevel blockchain system for IoT. *Pers. Ubiquitous Comput.* 2019, 1–8

[Hierarchical2020]Oktian Y E , Lee S G , Lee H J . Hierarchical Multi-Blockchain Architecture for Scalable Internet of Things Environment[J]. Electronics, 2020, 9(6):1050.

[YUAN2016]YUAN Y, WANG F Y． Blockchain: The State of the Art and Future Trends [J] ． Acta Automatica Sinica,２０１６,４２ (４ ) :481-494．  

